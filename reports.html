<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POLYMAX ‚Äì Reports & Analytics</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#f5f7fa 0%,#e8eef5 100%);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .top-bar{
      width:100%;
      background:#ffffff;
      padding:16px 32px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);
    }
    .top-left{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo{
      font-size:22px;
      font-weight:800;
      color:#3498db;
      letter-spacing:2px;
    }
    .page-title{
      font-size:20px;
      font-weight:600;
      color:#2c3e50;
    }
    .top-right span{color:#555;font-size:14px;}

    .back-btn{
      padding:8px 16px;
      border-radius:8px;
      border:none;
      background:#2c3e50;
      color:#fff;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
    }

    .page-container{
      max-width:1200px;
      width:100%;
      padding:24px;
    }

    .card{
      background:#ffffff;
      border-radius:16px;
      padding:24px 24px 28px;
      box-shadow:0 4px 15px rgba(0,0,0,0.08);
      margin-bottom:22px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin-bottom:16px;
      flex-wrap:wrap;
      gap:16px;
    }
    .card-title{
      font-size:18px;
      font-weight:600;
      color:#2c3e50;
    }
    .card-subtitle{
      font-size:13px;
      color:#7f8c8d;
      margin-top:2px;
    }

    .filters{
      display:flex;
      gap:12px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .filters label{
      font-size:12px;
      font-weight:600;
      color:#555;
    }
    .filters input{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:13px;
      min-width:150px;
    }
    .btn{
      padding:8px 16px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
    }
    .btn-primary{background:#3498db;color:#fff;}
    .btn-secondary{background:#3498db;color:#fff;}

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
      font-size:13px;
    }
    th{
      background:#f8f9fa;
      padding:10px 8px;
      text-align:left;
      font-weight:600;
      color:#495057;
      text-transform:uppercase;
      letter-spacing:0.3px;
      border-bottom:2px solid #dee2e6;
      white-space:nowrap;
    }
    td{
      padding:10px 8px;
      border-bottom:1px solid #f0f0f0;
      color:#555;
    }
    tbody tr:hover{background:#f8f9fa;}

    .empty-state{
      text-align:center;
      padding:32px 10px;
      color:#999;
    }
    .empty-state-icon{
      font-size:40px;
      margin-bottom:8px;
      opacity:0.35;
    }

    .footer{
      text-align:center;
      font-size:12px;
      color:#aaa;
      margin:10px 0 16px;
    }

    @media (max-width:768px){
      .page-container{padding:16px;}
      .top-bar{flex-direction:column;align-items:flex-start;gap:10px;}
    }
  </style>
</head>
<body>

  <!-- TOP BAR -->
  <header class="top-bar">
    <div class="top-left">
      <div class="logo">POLYMAX</div>
      <div>
        <div class="page-title">Reports & Analytics</div>
        <div style="font-size:12px;color:#7f8c8d;">Export Orders and Inventory as CSV reports</div>
      </div>
    </div>
    <div class="top-right">
      <button class="back-btn" onclick="window.location.href='dashboard.html'">‚Üê Back to Admin Panel</button>
    </div>
  </header>

  <main class="page-container">
    <!-- ORDERS REPORT CARD -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title"> Orders Report</div>
          <div class="card-subtitle">Select a date range, preview orders and download as CSV.</div>
        </div>

        <div class="filters">
          <div>
            <label for="reportFrom">From date</label><br>
            <input type="date" id="reportFrom">
          </div>
          <div>
            <label for="reportTo">To date</label><br>
            <input type="date" id="reportTo">
          </div>
          <button id="btnFilterOrders" class="btn btn-primary">Apply & Preview</button>
          <button id="btnDownloadOrders" class="btn btn-primary">Download Orders CSV</button>
        </div>
      </div>

      <div style="overflow-x:auto;">
        <table>
          <thead>
          <tr>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Order Date</th>
            <th>Method</th>
            <th>Status</th>
            <th>Qty</th>
            <th>Total</th>
          </tr>
          </thead>
          <tbody id="ordersReportBody">
          <tr>
            <td colspan="9">
              <div class="empty-state">
                <div class="empty-state-icon"></div>
                <div>Loading orders from Firebase...</div>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- INVENTORY REPORT CARD -->
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title"> Inventory Report</div>
          <div class="card-subtitle">Current snapshot of all products in the warehouse.</div>
        </div>

        <div class="filters">
          <button id="btnDownloadInventory" class="btn btn-secondary">Download Inventory CSV</button>
        </div>
      </div>

      <div style="overflow-x:auto;">
        <table>
          <thead>
          <tr>
            <th>Product</th>
            <th>Code</th>
            <th>Price</th>
            <th>Units in Hand</th>
            <th>Units on Order</th>
            <th>Total Sales</th>
            <th>Status</th>
          </tr>
          </thead>
          <tbody id="inventoryReportBody">
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <div class="empty-state-icon"></div>
                <div>Loading inventory from Firebase...</div>
              </div>
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <div class="footer">POLYMAX Warehouse Management System ¬© 2024</div>

  <!-- FIREBASE & SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // same config as dashboard
    const firebaseConfig = {
      apiKey: "AIzaSyCoCgLFdWbDk29T3Mo3L7DvoQ-x-hEDNWk",
      authDomain: "ware-house-robot.firebaseapp.com",
      projectId: "ware-house-robot",
      storageBucket: "ware-house-robot.firebasestorage.app",
      messagingSenderId: "1053408602269",
      appId: "1:1053408602269:web:fb276014330b5161488c74",
      measurementId: "G-73HM1FJ2FM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const reportFromInput = document.getElementById("reportFrom");
    const reportToInput = document.getElementById("reportTo");
    const btnFilterOrders = document.getElementById("btnFilterOrders");
    const btnDownloadOrders = document.getElementById("btnDownloadOrders");
    const btnDownloadInventory = document.getElementById("btnDownloadInventory");
    const ordersReportBody = document.getElementById("ordersReportBody");
    const inventoryReportBody = document.getElementById("inventoryReportBody");

    let allOrders = [];
    let allProducts = [];

    // ----- AUTH GUARD -----
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        // if not logged-in, go back to login
        window.location.href = "index.html";
      }
    });

    // ----- HELPERS -----
    function getOrderDateObj(order) {
      const v = order.orderDate;
      if (!v) return null;
      try {
        if (typeof v.toDate === "function") return v.toDate();
        if (typeof v.seconds === "number") return new Date(v.seconds * 1000);
        const d = new Date(v);
        return isNaN(d.getTime()) ? null : d;
      } catch {
        return null;
      }
    }

    function formatOrderDate(v) {
      if (!v) return "-";
      let d;
      try {
        if (typeof v.toDate === "function") d = v.toDate();
        else if (typeof v.seconds === "number") d = new Date(v.seconds * 1000);
        else d = new Date(v);
        if (!d || isNaN(d.getTime())) return "-";
        return d.toLocaleString("en-GB", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit"
        });
      } catch {
        return "-";
      }
    }

    function formatAmount(v) {
      if (v === undefined || v === null || v === "") return "-";
      const n = Number(v);
      if (isNaN(n)) return v;
      return "Rs. " + n.toLocaleString("en-LK");
    }

    function downloadCSV(filename, headers, rows) {
      const esc = (v) => {
        if (v === null || v === undefined) return "";
        const s = String(v).replace(/"/g, '""');
        return `"${s}"`;
      };
      const lines = [];
      lines.push(headers.map(esc).join(","));
      rows.forEach(r => lines.push(r.map(esc).join(",")));
      const blob = new Blob([lines.join("\r\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function filterOrdersByDate(orders, fromStr, toStr) {
      if (!fromStr && !toStr) return orders;
      const from = fromStr ? new Date(fromStr + "T00:00:00") : null;
      const to = toStr ? new Date(toStr + "T23:59:59") : null;
      return orders.filter(o => {
        const d = getOrderDateObj(o);
        if (!d) return false;
        if (from && d < from) return false;
        if (to && d > to) return false;
        return true;
      });
    }

    function renderOrders(orders) {
      if (!orders || orders.length === 0) {
        ordersReportBody.innerHTML = `
          <tr>
            <td colspan="9">
              <div class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <div>No orders found for this range.</div>
              </div>
            </td>
          </tr>`;
        return;
      }
      ordersReportBody.innerHTML = "";
      orders.forEach(o => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${o.orderId || o.id}</td>
          <td>${o.customerName || "-"}</td>
          <td>${o.customerEmail || "-"}</td>
          <td>${o.customerPhone || "-"}</td>
          <td>${formatOrderDate(o.orderDate)}</td>
          <td>${o.paymentMethod || "-"}</td>
          <td>${o.paymentStatus || "-"}</td>
          <td style="text-align:center;">${o.quantity || "-"}</td>
          <td style="text-align:right;">${formatAmount(o.totalAmount)}</td>`;
        ordersReportBody.appendChild(tr);
      });
    }

    function renderInventory(products) {
      if (!products || products.length === 0) {
        inventoryReportBody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <div class="empty-state-icon"></div>
                <div>No products found.</div>
              </div>
            </td>
          </tr>`;
        return;
      }
      inventoryReportBody.innerHTML = "";
      products.forEach(p => {
        let status;
        if (p.stock === 0) status = "Out of Stock";
        else if (p.stock < 100) status = "Low Stock";
        else status = "In Stock";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.code}</td>
          <td style="text-align:right;">${formatAmount(p.price)}</td>
          <td style="text-align:center;">${p.stock}</td>
          <td style="text-align:center;">${p.onOrder || 0}</td>
          <td style="text-align:center;">${p.salesTotal || 0}</td>
          <td>${status}</td>`;
        inventoryReportBody.appendChild(tr);
      });
    }

    // ----- LOAD DATA ONCE -----
    async function loadOrdersOnce() {
      if (allOrders.length > 0) return;
      const snap = await getDocs(collection(db, "Orders"));
      const arr = [];
      snap.forEach(docSnap => arr.push({ id: docSnap.id, ...docSnap.data() }));
      allOrders = arr;
    }

    async function loadProductsOnce() {
      if (allProducts.length > 0) return;
      const snap = await getDocs(collection(db, "products"));
      const arr = [];
      snap.forEach(docSnap => {
        const d = docSnap.data();
        const stock = Number(d.stock || 0);
        const salesJan = Number(d.salesJan || 0);
        const salesFeb = Number(d.salesFeb || 0);
        const salesMar = Number(d.salesMar || 0);
        arr.push({
          name: d.name || docSnap.id,
          code: d.code || docSnap.id,
          price: Number(d.price || 0),
          stock,
          onOrder: Number(d.onOrder || 0),
          salesTotal: salesJan + salesFeb + salesMar
        });
      });
      allProducts = arr;
    }

    // Initial load
    (async () => {
      try {
        await Promise.all([loadOrdersOnce(), loadProductsOnce()]);
        renderOrders(allOrders);
        renderInventory(allProducts);
      } catch (e) {
        console.error(e);
        ordersReportBody.innerHTML = `
          <tr><td colspan="9">Error loading orders: ${e.message}</td></tr>`;
        inventoryReportBody.innerHTML = `
          <tr><td colspan="7">Error loading inventory: ${e.message}</td></tr>`;
      }
    })();

    // ----- BUTTON EVENTS -----
    btnFilterOrders.addEventListener("click", () => {
      const from = reportFromInput.value;
      const to = reportToInput.value;
      const filtered = filterOrdersByDate(allOrders, from, to);
      renderOrders(filtered);
    });

    btnDownloadOrders.addEventListener("click", () => {
      const from = reportFromInput.value;
      const to = reportToInput.value;
      const filtered = filterOrdersByDate(allOrders, from, to);

      if (filtered.length === 0) {
        alert("No orders found for this date range.");
        renderOrders(filtered);
        return;
      }

      const headers = [
        "Order ID","Customer Name","Email","Phone",
        "Order Date","Payment Method","Status","Quantity","Total Amount"
      ];
      const rows = filtered.map(o => [
        o.orderId || o.id || "",
        o.customerName || "",
        o.customerEmail || "",
        o.customerPhone || "",
        formatOrderDate(o.orderDate),
        o.paymentMethod || "",
        o.paymentStatus || "",
        o.quantity || "",
        o.totalAmount || ""
      ]);

      downloadCSV("orders_report.csv", headers, rows);
    });

    btnDownloadInventory.addEventListener("click", () => {
      if (allProducts.length === 0) {
        alert("No inventory data to download.");
        return;
      }
      const headers = [
        "Product","Code","Price","Units in Hand","Units on Order","Total Sales","Status"
      ];
      const rows = allProducts.map(p => {
        let status;
        if (p.stock === 0) status = "Out of Stock";
        else if (p.stock < 100) status = "Low Stock";
        else status = "In Stock";
        return [
          p.name || "",
          p.code || "",
          p.price || "",
          p.stock || "",
          p.onOrder || "",
          p.salesTotal || "",
          status
        ];
      });

      downloadCSV("inventory_report.csv", headers, rows);
    });

  </script>
</body>
</html>
